# Caddy web server config for Sensorgnome
#

{
        admin off
        #ocsp_stapling off
        auto_https disable_redirects
        on_demand_tls {
                ask http://localhost:8081/ip-ok
        }
}

# Primary site is on HTTPS with any IP address or hostname, a self-signed cert
# (really a cert generated by a local CA) is automatically generated when a hostname is first used.
:443 {
        log {
                format filter {
                        wrap console
                        fields {
                                request>headers delete
                                resp_headers delete
                                user_id replace "HTTPS-443"
                        }
                }
        }
        # where to look for files
        root * /opt/sensorgnome/web-portal/public
        # if path is / and file need_init exists then rewrite to config.html
        # so the user gets the initial configuration stuff
        @start_init {
                path /
                file need_init
        }
        rewrite @start_init /init/config
        # handle initial configuration paths
        handle_path /init/* {
                # if the request doesn't match a file, try an action
                @init_action not file {path}
                reverse_proxy @init_action localhost:8081
                # else serve file
                file_server
        }
        # handle captive portal magic
        redir /generate_204 /
        redir /gen_204 /
        redir /blank.html /
        redir /mobile/status.php /
        redir /hotspot-detect.html /
        @captive_ua header User-Agent *CaptiveNetworkSupport*
        redir @captive_ua /init/apple-hotspot.html
        # error if we need init and nothing above handles the request
        @need_init file need_init
        respond @need_init 404
        # normal sg-control app only if init is done
        reverse_proxy localhost:8080
        # ensure we get automatic certs and redirect from HTTP
        tls internal {
                on_demand
        }
}

# Redirect used by ethernet and wifi client interfaces
:80 {
        log {
                format filter {
                        wrap console
                        fields {
                                request>headers delete
                                resp_headers delete
                                common_log delete
                                user_id replace "HTTP-eth"
                        }
                }
        }
        rewrite * /redirect
        reverse_proxy localhost:8081
}

# Hotspot interface
http://:81 {
        log {
                format filter {
                        wrap console
                        fields {
                                request>headers delete
                                resp_headers delete
                                common_log delete
                                user_id replace "HTTP-hotspot"
                        }
                }
        }
        @capture not path /captive /set-time
        rewrite @capture /redirect-hs
        reverse_proxy localhost:8081
}

# Arbitrary hostnames captured by portal
http://:82 {
        log {
                format filter {
                        wrap console
                        fields {
                                request>headers delete
                                resp_headers delete
                                common_log delete
                                user_id replace "HTTP-captive"
                        }
                }
        }
        redir http://192.168.7.2/
}

# Refer to the Caddy docs for more information:
# https://caddyserver.com/docs/caddyfile
